name: Issue Analyzer & Responder

on:
  issues:
    types: [opened]

jobs:
  analyze-issue:
    runs-on: ubuntu-latest
    if: github.event.issue.user.login != github.repository_owner
    permissions:
      issues: write
      pull-requests: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Analyze and Comment
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          REPO: ${{ github.repository }}
        run: |
          # 1. Define the welcome message
          WELCOME_MSG="Hi @${{ github.event.issue.user.login }}! ðŸ‘‹\n\nThank you for opening this issue. Our team will review it soon and get back to you.\n\n"
          
          echo "Searching for related issues and PRs for: $ISSUE_TITLE"
          
          # 2. Search for issues (excluding the current one)
          # We use jq to filter and format
          RELATED_ISSUES=$(gh search issues "$ISSUE_TITLE" --repo "$REPO" --limit 10 --json number,title,url | \
            jq -r --arg current "$ISSUE_NUMBER" '.[] | select(.number != ($current | tonumber)) | "- [#" + (.number | toString) + "](" + .url + "): " + .title' | head -n 5)

          # 3. Search for related PRs
          RELATED_PRS=$(gh search prs "$ISSUE_TITLE" --repo "$REPO" --limit 5 --json number,title,url | \
            jq -r '.[] | "- [#" + (.number | toString) + "](" + .url + "): " + .title')

          # 4. Build the final response
          FINAL_MSG="$WELCOME_MSG"
          
          if [ -n "$RELATED_ISSUES" ]; then
            FINAL_MSG="${FINAL_MSG}### Related Issues Found:\n${RELATED_ISSUES}\n\n"
          fi
          
          if [ -n "$RELATED_PRS" ]; then
            FINAL_MSG="${FINAL_MSG}### Related Pull Requests Found:\n${RELATED_PRS}\n\n"
          fi
          
          if [ -z "$RELATED_ISSUES" ] && [ -z "$RELATED_PRS" ]; then
             FINAL_MSG="${FINAL_MSG}*No highly related issues or PRs were found, but we'll take a look as soon as possible.*"
          fi

          # 5. Post the comment
          gh issue comment "$ISSUE_NUMBER" --body "$(echo -e "$FINAL_MSG")"
